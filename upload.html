<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Post</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF554F;
            --dark-bg: #282828;
            --light-text: #FAFAFA;
            --gray-text: #9E9E9E;
            --card-bg: #212121;
            --input-bg: #242424;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark-bg);
            margin: 0;
            padding: 0;
            color: var(--light-text);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0;
        }
        
        .action-bar {
            background-color: var(--dark-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .back-button {
            color: var(--light-text);
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .action-title {
            flex-grow: 1;
            font-size: 16px;
            font-weight: 500;
        }
        
        .post-button {
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
        }
        
        .content {
            background-color: #FAFAFA;
            min-height: calc(100vh - 56px);
            padding: 15px;
        }
        
        .section-title {
            color: var(--gray-text);
            font-size: 14px;
            margin: 15px 0 8px 0;
        }
        
        .post-input {
            width: 100%;
            background-color: var(--input-bg);
            border: none;
            border-radius: 8px;
            padding: 15px;
            color: var(--light-text);
            font-size: 14px;
            resize: none;
            min-height: 150px;
            box-sizing: border-box;
        }
        
        .post-input::placeholder {
            color: var(--gray-text);
        }
        
        .attachment-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .attachment-button {
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            color: var(--gray-text);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .attachment-button:hover {
            background-color: #333;
        }
        
        .attachment-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .attachment-icon {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .selected-images {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
        }
        
        .selected-image {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            position: relative;
        }
        
        .image-container {
            position: relative;
            display: inline-block;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .video-section {
            margin-top: 20px;
            display: none;
        }
        
        .video-details {
            background-color: var(--input-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .detail-label {
            width: 80px;
            color: var(--light-text);
            font-size: 14px;
        }
        
        .detail-value {
            flex-grow: 1;
            color: var(--light-text);
            font-size: 14px;
        }
        
        .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-button i {
            margin-right: 8px;
        }
        
        .thumbnail-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            object-fit: cover;
            margin: 10px 0;
            display: none;
        }
        
        .thumbnail-preview.small {
            width: 180px;
            height: 180px;
        }
        
        .advance-options {
            margin-top: 20px;
        }
        
        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .option-label {
            color: var(--light-text);
            font-size: 14px;
        }
        
        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
        
        .uploading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #FAFAFA;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .uploading-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 20px;
        }
        
        .uploading-text {
            color: var(--primary-color);
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .task-text {
            color: var(--gray-text);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            max-width: 300px;
            height: 6px;
            background-color: #E0E0E0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: var(--light-text);
            font-size: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        input[type="file"] {
            display: none;
        }

        .video-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border-radius: 8px;
            margin: 10px 0;
            background-color: #000;
        }

        .error-message {
            color: var(--primary-color);
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Action Bar -->
        <div class="action-bar">
            <div class="back-button" onclick="goBack()">←</div>
            <div class="action-title">New Post</div>
            <div class="post-button" onclick="uploadPost()">Post</div>
        </div>
        
        <!-- Main Content -->
        <div class="content" id="main-content">
            <div class="section-title">Say Something!</div>
            <textarea class="post-input" id="post-text" placeholder="What's your &quot;MANN&quot; ???"></textarea>
            
            <!-- Attachment Options -->
            <div class="attachment-options">
                <label for="image-upload" class="attachment-button" id="image-btn">
                    <i class="material-icons attachment-icon">image</i>
                    <span>Images</span>
                </label>
                <label for="video-upload" class="attachment-button" id="video-btn">
                    <i class="material-icons attachment-icon">videocam</i>
                    <span>Video</span>
                </label>
            </div>
            
            <input type="file" id="image-upload" accept="image/*" multiple>
            <input type="file" id="video-upload" accept="video/*">
            <input type="file" id="thumbnail-upload" accept="image/*">
            
            <!-- Selected Images -->
            <div class="selected-images" id="selected-images"></div>
            
            <!-- Video Section -->
            <div class="video-section" id="video-section">
                <div class="section-title">Video Details</div>
                
                <button class="action-button" id="change-video-btn" onclick="document.getElementById('video-upload').click()">
                    <i class="material-icons">videocam</i>
                    Change Video
                </button>
                
                <div class="video-details">
                    <div class="detail-row">
                        <div class="detail-label">Name:</div>
                        <div class="detail-value" id="video-name">No video selected</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Size:</div>
                        <div class="detail-value" id="video-size">0 MB</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Duration:</div>
                        <div class="detail-value" id="video-duration">00:00</div>
                    </div>
                </div>
                
                <!-- Video Preview -->
                <video id="video-preview" class="video-preview" controls style="display: none;">
                    Your browser does not support the video tag.
                </video>
                
                <div class="section-title" id="thumbnail-section-title">Add Video Thumbnail</div>
                
                <button class="action-button" id="thumbnail-btn" onclick="document.getElementById('thumbnail-upload').click()">
                    <i class="material-icons">image</i>
                    Pick Thumbnail
                </button>
                
                <img src="" class="thumbnail-preview" id="thumbnail-preview">
                <img src="" class="thumbnail-preview small" id="short-thumbnail-preview">
                
                <div class="section-title" id="video-title-section">Video Title</div>
                <input type="text" class="post-input" id="video-title" placeholder="Video Title" style="min-height: auto;">
                
                <div class="section-title advance-options">Advanced Options</div>
                
                <div class="option-row">
                    <div class="option-label">Disable Comments</div>
                    <label class="switch">
                        <input type="checkbox" id="disable-comment">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <div class="option-row">
                    <div class="option-label">Disable Share</div>
                    <label class="switch">
                        <input type="checkbox" id="disable-share">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <div class="option-row">
                    <div class="option-label">Disable Download</div>
                    <label class="switch">
                        <input type="checkbox" id="disable-download">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Uploading Screen -->
        <div class="uploading-screen" id="uploading-screen">
            <img src="https://via.placeholder.com/150x150/FF554F/FFFFFF?text=LOGO" class="uploading-image">
            <div class="uploading-text">Uploading Please Wait...</div>
            <div class="task-text" id="task-text">TASK 0/0</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">0% Uploaded...</div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB49vRPX8YaWuTP5GS3lsBDqdAaz_hJYAw",
            authDomain: "onlineshop-849c8.firebaseapp.com",
            databaseURL: "https://onlineshop-849c8.firebaseio.com",
            projectId: "onlineshop-849c8",
            storageBucket: "onlineshop-849c8.appspot.com",
            messagingSenderId: "883512833370",
            appId: "1:883512833370:web:a1c8412b158f8744afef63"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Current user and upload data
        let currentUser = null;
        let selectedImages = [];
        let selectedVideo = null;
        let selectedThumbnail = null;
        let isShortVideo = false;
        let uploadTasks = [];
        let currentUploadIndex = 0;
        let postKey = null;
        let currentMode = 'text'; // 'text', 'image', 'video'
        
        // DOM elements
        const postText = document.getElementById('post-text');
        const imageUpload = document.getElementById('image-upload');
        const videoUpload = document.getElementById('video-upload');
        const thumbnailUpload = document.getElementById('thumbnail-upload');
        const selectedImagesContainer = document.getElementById('selected-images');
        const videoSection = document.getElementById('video-section');
        const videoName = document.getElementById('video-name');
        const videoSize = document.getElementById('video-size');
        const videoDuration = document.getElementById('video-duration');
        const videoPreview = document.getElementById('video-preview');
        const thumbnailPreview = document.getElementById('thumbnail-preview');
        const shortThumbnailPreview = document.getElementById('short-thumbnail-preview');
        const videoTitle = document.getElementById('video-title');
        const changeVideoBtn = document.getElementById('change-video-btn');
        const thumbnailBtn = document.getElementById('thumbnail-btn');
        const uploadingScreen = document.getElementById('uploading-screen');
        const taskText = document.getElementById('task-text');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const disableComment = document.getElementById('disable-comment');
        const disableShare = document.getElementById('disable-share');
        const disableDownload = document.getElementById('disable-download');
        const imageBtn = document.getElementById('image-btn');
        const videoBtn = document.getElementById('video-btn');
        const thumbnailSectionTitle = document.getElementById('thumbnail-section-title');
        const videoTitleSection = document.getElementById('video-title-section');
        
        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'index.html';
            }
        });
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' B';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        }
        
        // Helper function to format duration
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Reset all selections
        function resetSelections() {
            selectedImages = [];
            selectedVideo = null;
            selectedThumbnail = null;
            isShortVideo = false;
            selectedImagesContainer.innerHTML = '';
            videoSection.style.display = 'none';
            imageBtn.classList.remove('active');
            videoBtn.classList.remove('active');
            videoPreview.style.display = 'none';
            thumbnailPreview.style.display = 'none';
            shortThumbnailPreview.style.display = 'none';
            videoTitle.value = '';
        }
        
               // Handle image upload
        imageUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                resetSelections();
                currentMode = 'image';
                imageBtn.classList.add('active');
                
                // Process each file
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            selectedImages.push({
                                file: file,
                                url: event.target.result
                            });
                            
                            // Display selected images
                            renderSelectedImages();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // Render selected images
        function renderSelectedImages() {
            selectedImagesContainer.innerHTML = '';
            selectedImages.forEach((image, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                
                const img = document.createElement('img');
                img.src = image.url;
                img.className = 'selected-image';
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = () => removeImage(index);
                
                imageContainer.appendChild(img);
                imageContainer.appendChild(removeBtn);
                selectedImagesContainer.appendChild(imageContainer);
            });
        }

        // Remove selected image
        function removeImage(index) {
            selectedImages.splice(index, 1);
            renderSelectedImages();
            
            if (selectedImages.length === 0) {
                currentMode = 'text';
                imageBtn.classList.remove('active');
            }
        }

        // Handle video upload
        videoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('video/')) {
                resetSelections();
                currentMode = 'video';
                videoBtn.classList.add('active');
                videoSection.style.display = 'block';
                
                selectedVideo = file;
                videoName.textContent = file.name;
                videoSize.textContent = formatFileSize(file.size);
                
                // Create video element to get duration
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = () => {
                    window.URL.revokeObjectURL(video.src);
                    videoDuration.textContent = formatDuration(video.duration);
                    isShortVideo = video.duration <= 60; // 1 minute or less
                    
                    // Show video preview
                    videoPreview.src = URL.createObjectURL(file);
                    videoPreview.style.display = 'block';
                    
                    // Set default thumbnail section title based on video length
                    thumbnailSectionTitle.textContent = isShortVideo ? 
                        'Add Short Video Thumbnail' : 'Add Video Thumbnail';
                    videoTitleSection.style.display = isShortVideo ? 'none' : 'block';
                };
                video.src = URL.createObjectURL(file);
            }
        });

        // Handle thumbnail upload
        thumbnailUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedThumbnail = file;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (isShortVideo) {
                        shortThumbnailPreview.src = event.target.result;
                        shortThumbnailPreview.style.display = 'block';
                    } else {
                        thumbnailPreview.src = event.target.result;
                        thumbnailPreview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Go back button
        function goBack() {
            window.history.back();
        }

        // Upload post to Firebase
        function uploadPost() {
            if (!currentUser) {
                alert('Please sign in to post');
                return;
            }
            
            const text = postText.value.trim();
            const timestamp = Date.now();
            postKey = database.ref('posts').push().key;
            
            // Validate inputs based on mode
            if (currentMode === 'image' && selectedImages.length === 0) {
                alert('Please select at least one image');
                return;
            }
            
            if (currentMode === 'video' && !selectedVideo) {
                alert('Please select a video');
                return;
            }
            
            if (currentMode === 'video' && !isShortVideo && !selectedThumbnail) {
                alert('Please select a thumbnail for your video');
                return;
            }
            
            // Show uploading screen
            uploadingScreen.style.display = 'flex';
            
            // Prepare post data
            const postData = {
                uid: currentUser.uid,
                text: text,
                timestamp: timestamp,
                likes: 0,
                comments: 0,
                shares: 0,
                type: currentMode,
                disableComment: disableComment.checked,
                disableShare: disableShare.checked,
                disableDownload: disableDownload.checked
            };
            
            // Reset upload tasks
            uploadTasks = [];
            currentUploadIndex = 0;
            
            // Handle different post types
            if (currentMode === 'image') {
                uploadImages(postData);
            } 
            else if (currentMode === 'video') {
                uploadVideo(postData);
            } 
            else {
                savePost(postData);
            }
        }

        function uploadImages(postData) {
            selectedImages.forEach((image, index) => {
                const imagePath = `posts/${currentUser.uid}/${postKey}/images/${index}`;
                const uploadTask = storage.ref(imagePath).put(image.file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => updateProgress(snapshot, index),
                    (error) => handleUploadError(error),
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            if (!postData.images) postData.images = [];
                            postData.images.push(downloadURL);
                            
                            if (postData.images.length === selectedImages.length) {
                                savePost(postData);
                            }
                        });
                    }
                );
                
                uploadTasks.push(uploadTask);
            });
            
            taskText.textContent = `Uploading images (1/${selectedImages.length})`;
        }

        function uploadVideo(postData) {
            const videoPath = `posts/${currentUser.uid}/${postKey}/video`;
            const videoUploadTask = storage.ref(videoPath).put(selectedVideo);
            
            videoUploadTask.on('state_changed', 
                (snapshot) => updateProgress(snapshot, 0),
                (error) => handleUploadError(error),
                () => {
                    videoUploadTask.snapshot.ref.getDownloadURL().then((videoURL) => {
                        postData.videoUrl = videoURL;
                        
                        if (isShortVideo) {
                            savePost(postData);
                        } 
                        else if (selectedThumbnail) {
                            uploadThumbnail(postData);
                        }
                    });
                }
            );
            
            uploadTasks.push(videoUploadTask);
            taskText.textContent = 'Uploading video (1/2)';
        }

        function uploadThumbnail(postData) {
            taskText.textContent = 'Uploading thumbnail';
            
            const thumbPath = `posts/${currentUser.uid}/${postKey}/thumbnail`;
            const thumbUploadTask = storage.ref(thumbPath).put(selectedThumbnail);
            
            thumbUploadTask.on('state_changed', 
                (snapshot) => updateProgress(snapshot, 1),
                (error) => handleUploadError(error),
                () => {
                    thumbUploadTask.snapshot.ref.getDownloadURL().then((thumbURL) => {
                        postData.thumbnailUrl = thumbURL;
                        postData.videoTitle = videoTitle.value;
                        savePost(postData);
                    });
                }
            );
            
            uploadTasks.push(thumbUploadTask);
        }

        function updateProgress(snapshot, taskIndex) {
            currentUploadIndex = taskIndex;
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}% Uploaded...`;
            
            if (currentMode === 'image') {
                taskText.textContent = `Uploading images (${currentUploadIndex + 1}/${selectedImages.length})`;
            } else if (currentMode === 'video') {
                const totalTasks = isShortVideo ? 1 : 2;
                taskText.textContent = `Uploading ${currentUploadIndex === 0 ? 'video' : 'thumbnail'} (${currentUploadIndex + 1}/${totalTasks})`;
            }
        }

        function handleUploadError(error) {
            console.error('Upload failed:', error);
            alert('Upload failed: ' + error.message);
            uploadingScreen.style.display = 'none';
        }

        function savePost(postData) {
            database.ref('posts/' + postKey).set(postData)
                .then(() => {
                    // Update user's posts count
                    database.ref('users/' + currentUser.uid + '/postCount').transaction((count) => {
                        return (count || 0) + 1;
                    });
                    
                    setTimeout(() => {
                        uploadingScreen.style.display = 'none';
                        window.location.href = 'home.html';
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Error saving post:', error);
                    alert('Error saving post: ' + error.message);
                    uploadingScreen.style.display = 'none';
                });
        }
    </script>
</body>
</html>
