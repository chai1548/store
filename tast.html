<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Social App with Firebase</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, limit, where, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB49vRPX8YaWuTP5GS3lsBDqdAaz_hJYAw",
            authDomain: "onlineshop-849c8.firebaseapp.com",
            databaseURL: "https://onlineshop-849c8.firebaseio.com",
            projectId: "onlineshop-849c8",
            storageBucket: "onlineshop-849c8.appspot.com",
            messagingSenderId: "883512833370",
            appId: "1:883512833370:web:a1c8412b158f8744afef63"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        window.firebaseServices = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            serverTimestamp,
            query,
            orderBy,
            limit,
            where,
            getDoc,
            ref,
            uploadBytes,
            getDownloadURL,
            uploadBytesResumable
        };

        // Initialize app when Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (window.initializeApp) {
                window.initializeApp();
            }
        });
    </script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .nav-link {
            position: relative;
            padding: 0.75rem 1.5rem;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .upload-zone {
            border: 2px dashed rgba(102, 126, 234, 0.5);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .post-image, .post-video {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .notification.error {
            background: linear-gradient(135deg, #f87171, #ef4444);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .comment-input {
            border: 1px solid #e2e8f0;
            border-radius: 2rem;
            padding: 0.75rem 1rem;
            width: 100%;
            focus:outline-none;
            focus:ring-2;
            focus:ring-indigo-500;
        }

        .story-ring {
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            padding: 3px;
            border-radius: 50%;
        }

        .story-inner {
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        @media print {
            body {
                background: white !important;
            }
            
            .app-container {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            .hide-in-print {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 1rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* New styles for search, comments, etc */
        .search-box {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2rem;
            padding: 0.5rem 1rem;
            color: white;
            width: 200px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            width: 250px;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .comment-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .comment-container::-webkit-scrollbar {
            width: 6px;
        }

        .comment-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .comment-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 0.75rem 0;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-content {
            max-width: 350px;
            max-height: 600px;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .story-nav {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }

        .story-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome to SocialApp</h2>
                <p class="text-gray-600">Sign in to continue</p>
            </div>
            
            <div id="authTabs" class="flex mb-6">
                <button id="loginTab" class="flex-1 py-2 px-4 text-center border-b-2 border-indigo-500 text-indigo-600 font-semibold">Login</button>
                <button id="registerTab" class="flex-1 py-2 px-4 text-center border-b-2 border-gray-200 text-gray-500">Register</button>
            </div>
            
            <form id="authForm">
                <div class="mb-4">
                    <input type="email" id="authEmail" placeholder="Email address" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <input type="password" id="authPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div id="registerFields" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="authName" placeholder="Full Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <button type="submit" class="w-full btn-primary mb-4">
                    <span id="authButtonText">Sign In</span>
                </button>
            </form>
            
            <div class="text-center">
                <div class="mb-4 text-gray-500">or</div>
                <button id="googleAuth" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center">
                    <i class="fab fa-google mr-2"></i>
                    Continue with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Story Viewer -->
    <div id="storyViewer" class="story-viewer hidden">
        <div class="story-content">
            <div class="story-nav">
                <button id="closeStory" class="text-white text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="story-progress">
                <div class="story-progress-fill"></div>
            </div>
            <img id="storyImage" src="" alt="Story" class="w-full h-full object-cover">
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-effect">
        <div class="app-container">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white mr-4">
                        <i class="fas fa-share-alt mr-2"></i>SocialApp
                    </h1>
                    <span class="bg-white bg-opacity-20 text-white text-xs font-semibold px-3 py-1 rounded-full">Firebase</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Search Box -->
                    <div class="relative hidden md:block">
                        <input type="text" id="searchBox" placeholder="Search..." class="search-box">
                        <i class="fas fa-search absolute right-3 top-2 text-white"></i>
                    </div>
                    
                    <div id="userInfo" class="hidden flex items-center space-x-3">
                        <img id="userAvatar" src="" alt="User" class="user-avatar">
                        <span id="userName" class="text-white font-medium"></span>
                        <button id="logoutBtn" class="text-white hover:text-red-300 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="mainNav" class="hidden flex space-x-2 pb-4">
                <a href="#" class="nav-link active" data-page="home">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <a href="#" class="nav-link" data-page="upload">
                    <i class="fas fa-plus mr-2"></i>Create
                </a>
                <a href="#" class="nav-link" data-page="profile">
                    <i class="fas fa-user mr-2"></i>Profile
                </a>
                <a href="#" class="nav-link" data-page="settings">
                    <i class="fas fa-cog mr-2"></i>Settings
                </a>
            </div>
        </div>
    </nav>

    <main class="app-container py-6">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <!-- Stories Section -->
            <div class="card glass-effect mb-6">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Stories</h3>
                    <div class="flex space-x-4 overflow-x-auto pb-2" id="storiesContainer">
                        <!-- Stories will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Posts Feed -->
            <div id="postsContainer">
                <!-- Posts will be loaded here -->
            </div>

            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Load More Posts
                </button>
            </div>
        </div>

        <!-- Upload Page -->
        <div id="upload-page" class="page">
            <div class="card">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Post</h2>
                    
                    <!-- Upload Tabs -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button class="upload-tab active" data-type="text">
                            <i class="fas fa-font mr-2"></i>Text Post
                        </button>
                        <button class="upload-tab" data-type="image">
                            <i class="fas fa-image mr-2"></i>Image Post
                        </button>
                        <button class="upload-tab" data-type="video">
                            <i class="fas fa-video mr-2"></i>Video Post
                        </button>
                    </div>

                    <!-- Text Post Form -->
                    <div id="textUpload" class="upload-form">
                        <form id="textPostForm">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Post Content</label>
                                <textarea id="textContent" rows="4" placeholder="What's on your mind?" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tags (optional)</label>
                                <input type="text" id="textTags" placeholder="Enter tags separated by commas" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane mr-2"></i>Publish Post
                            </button>
                        </form>
                    </div>

                    <!-- Image Post Form -->
                    <div id="imageUpload" class="upload-form hidden">
                        <form id="imagePostForm">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Images</label>
                                <div class="upload-zone" id="imageDropzone">
                                    <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-4"></i>
                                        <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop images here</p>
                                        <p class="text-sm text-gray-500">or click to select files</p>
                                        <p class="text-xs text-gray-400 mt-2">Supports: JPG, PNG, GIF (Max 10MB each)</p>
                                    </div>
                                </div>
                                <div id="imagePreview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Caption</label>
                                <textarea id="imageCaption" rows="3" placeholder="Write a caption for your images..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tags (optional)</label>
                                <input type="text" id="imageTags" placeholder="Enter tags separated by commas" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="mb-4">
                                <div class="progress-bar hidden" id="imageProgress">
                                    <div class="progress-fill"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-images mr-2"></i>Publish Images
                            </button>
                        </form>
                    </div>

                    <!-- Video Post Form -->
                    <div id="videoUpload" class="upload-form hidden">
                        <form id="videoPostForm">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Video</label>
                                <div class="upload-zone" id="videoDropzone">
                                    <input type="file" id="videoInput" accept="video/*" class="hidden">
                                    <div class="text-center">
                                        <i class="fas fa-film text-4xl text-indigo-400 mb-4"></i>
                                        <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop video here</p>
                                        <p class="text-sm text-gray-500">or click to select file</p>
                                        <p class="text-xs text-gray-400 mt-2">Supports: MP4, WebM, MOV (Max 100MB)</p>
                                    </div>
                                </div>
                                <div id="videoPreview" class="mt-4 hidden">
                                    <video id="previewVideo" controls playsinline webkit-playsinline class="w-full max-h-96 rounded-lg"></video>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="videoDescription" rows="3" placeholder="Describe your video..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tags (optional)</label>
                                <input type="text" id="videoTags" placeholder="Enter tags separated by commas" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="mb-4">
                                <div class="progress-bar hidden" id="videoProgress">
                                    <div class="progress-fill"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-video mr-2"></i>Publish Video
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page">
            <div class="card">
                <div class="p-6">
                    <div class="text-center mb-8">
                        <div class="relative inline-block">
                            <img id="profileAvatar" src="" alt="Profile" class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-lg">
                            <button id="changeAvatarBtn" class="absolute bottom-0 right-0 bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 transition-colors">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="avatarInput" accept="image/*" class="hidden">
                        </div>
                        <h2 id="profileName" class="text-2xl font-bold text-gray-800 mt-4">User Name</h2>
                        <p id="profileEmail" class="text-gray-600">user@example.com</p>
                        <p id="profileBio" class="text-gray-600 mt-2 max-w-md mx-auto"></p>
                        <div class="flex justify-center mt-4 space-x-6">
                            <div class="text-center">
                                <div id="postCount" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Posts</div>
                            </div>
                            <div class="text-center">
                                <div id="followerCount" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Followers</div>
                            </div>
                            <div class="text-center">
                                <div id="followingCount" class="text-2xl font-bold text-gray-800">0</div>
                                <div class="text-sm text-gray-600">Following</div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">My Posts</h3>
                        <div id="userPosts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- User posts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="page">
            <div class="card">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Account Information</h3>
                            <form id="profileForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                                        <input type="text" id="settingsName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                        <input type="email" id="settingsEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" readonly>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                                    <textarea id="settingsBio" rows="3" placeholder="Tell us about yourself..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="btn-primary">
                                        <i class="fas fa-save mr-2"></i>Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Privacy Settings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-medium text-gray-800">Profile Visibility</h4>
                                        <p class="text-sm text-gray-600">Control who can see your profile</p>
                                    </div>
                                    <select id="privacySetting" class="p-2 border border-gray-300 rounded-lg">
                                        <option value="public">Public</option>
                                        <option value="friends">Friends Only</option>
                                        <option value="private">Private</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-medium text-gray-800">Allow Comments</h4>
                                        <p class="text-sm text-gray-600">Let others comment on your posts</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="allowComments" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Dangerous Actions</h3>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <button id="deleteAccountBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium">
                                    <i class="fas fa-trash mr-2"></i>Delete Account
                                </button>
                                <p class="text-sm text-red-600 mt-2">This action cannot be undone. All your data will be permanently deleted.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Comments</h3>
                <button id="closeCommentModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="comment-container mb-4" id="commentList">
                <!-- Comments will be loaded here -->
            </div>
            
            <div class="flex items-center">
                <input type="text" id="commentInput" placeholder="Write a comment..." class="comment-input flex-1 mr-2">
                <button id="postCommentBtn" class="btn-primary px-4 py-2">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let selectedFiles = [];
        let uploadProgress = {};
        let currentPostId = null;
        let stories = [];
        let currentStoryIndex = 0;
        let storyInterval;

        // Initialize app
        window.initializeApp = function() {
            setupAuthListeners();
            setupNavigation();
            setupUploadForms();
            setupEventListeners();
            setupCommentModal();
            setupStoryViewer();
            
            // Check authentication state
            window.firebaseServices.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadUserData();
                    loadPosts();
                    loadStories();
                    
                    // Setup search functionality
                    setupSearch();
                } else {
                    currentUser = null;
                    showAuthModal();
                }
            });
        };

        // Authentication functions
        function setupAuthListeners() {
            const authModal = document.getElementById('authModal');
            const authForm = document.getElementById('authForm');
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const googleAuth = document.getElementById('googleAuth');
            const logoutBtn = document.getElementById('logoutBtn');

            // Tab switching
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));

            // Form submission
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const name = document.getElementById('authName').value;
                const isRegister = registerTab.classList.contains('border-indigo-500');

                try {
                    if (isRegister) {
                        await window.firebaseServices.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                        // Save user profile
                        await window.firebaseServices.addDoc(window.firebaseServices.collection(window.firebaseDB, 'users'), {
                            uid: window.firebaseAuth.currentUser.uid,
                            name: name || 'User',
                            email: email,
                            bio: '',
                            privacy: 'public',
                            allowComments: true,
                            createdAt: window.firebaseServices.serverTimestamp()
                        });
                        showNotification('Account created successfully!', 'success');
                    } else {
                        await window.firebaseServices.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                        showNotification('Welcome back!', 'success');
                    }
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });

            // Google Auth
            googleAuth.addEventListener('click', async () => {
                try {
                    const provider = new window.firebaseServices.GoogleAuthProvider();
                    const result = await window.firebaseServices.signInWithPopup(window.firebaseAuth, provider);
                    
                    // Check if user exists in Firestore
                    const userDoc = await window.firebaseServices.getDoc(
                        window.firebaseServices.doc(window.firebaseDB, 'users', result.user.uid)
                    );
                    
                    if (!userDoc.exists()) {
                        // Create user profile
                        await window.firebaseServices.setDoc(
                            window.firebaseServices.doc(window.firebaseDB, 'users', result.user.uid),
                            {
                                uid: result.user.uid,
                                name: result.user.displayName || 'User',
                                email: result.user.email,
                                bio: '',
                                privacy: 'public',
                                allowComments: true,
                                createdAt: window.firebaseServices.serverTimestamp()
                            }
                        );
                    }
                    
                    showNotification('Signed in with Google!', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await window.firebaseServices.signOut(window.firebaseAuth);
                    showNotification('Signed out successfully!', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const registerFields = document.getElementById('registerFields');
            const authButtonText = document.getElementById('authButtonText');

            if (tab === 'login') {
                loginTab.classList.add('border-indigo-500', 'text-indigo-600');
                loginTab.classList.remove('border-gray-200', 'text-gray-500');
                registerTab.classList.add('border-gray-200', 'text-gray-500');
                registerTab.classList.remove('border-indigo-500', 'text-indigo-600');
                registerFields.classList.add('hidden');
                authButtonText.textContent = 'Sign In';
            } else {
                registerTab.classList.add('border-indigo-500', 'text-indigo-600');
                registerTab.classList.remove('border-gray-200', 'text-gray-500');
                loginTab.classList.add('border-gray-200', 'text-gray-500');
                loginTab.classList.remove('border-indigo-500', 'text-indigo-600');
                registerFields.classList.remove('hidden');
                authButtonText.textContent = 'Sign Up';
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
            document.getElementById('mainNav').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('mainNav').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
        }

        // Navigation
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = link.getAttribute('data-page');
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show target page
                    pages.forEach(page => {
                        if (page.id === `${targetPage}-page`) {
                            page.classList.add('active');
                        } else {
                            page.classList.remove('active');
                        }
                    });
                    
                    // Load specific page data
                    if (targetPage === 'profile') {
                        loadProfileData();
                    } else if (targetPage === 'settings') {
                        loadSettingsData();
                    }
                });
            });
        }

        // Upload forms
        function setupUploadForms() {
            // Tab switching
            const uploadTabs = document.querySelectorAll('.upload-tab');
            const uploadForms = document.querySelectorAll('.upload-form');

            uploadTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const type = tab.getAttribute('data-type');
                    
                    uploadTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    uploadForms.forEach(form => {
                        if (form.id === `${type}Upload`) {
                            form.classList.remove('hidden');
                        } else {
                            form.classList.add('hidden');
                        }
                    });
                });
            });

            // Image upload
            setupImageUpload();
            
            // Video upload
            setupVideoUpload();
            
            // Form submissions
            setupFormSubmissions();
            
            // Profile picture upload
            setupProfilePictureUpload();
        }

        function setupImageUpload() {
            const imageDropzone = document.getElementById('imageDropzone');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');

            imageDropzone.addEventListener('click', () => imageInput.click());
            
            imageDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageDropzone.classList.add('border-indigo-500');
            });
            
            imageDropzone.addEventListener('dragleave', () => {
                imageDropzone.classList.remove('border-indigo-500');
            });
            
            imageDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                imageDropzone.classList.remove('border-indigo-500');
                handleImageFiles(e.dataTransfer.files);
            });
            
            imageInput.addEventListener('change', (e) => {
                handleImageFiles(e.target.files);
            });

            function handleImageFiles(files) {
                selectedFiles = Array.from(files);
                imagePreview.innerHTML = '';
                
                selectedFiles.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.createElement('div');
                            preview.className = 'relative';
                            preview.innerHTML = `
                                <img src="${e.target.result}" alt="Preview" class="w-full h-32 object-cover rounded-lg">
                                <button type="button" onclick="removeFile(${index})" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">×</button>
                            `;
                            imagePreview.appendChild(preview);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        function setupVideoUpload() {
            const videoDropzone = document.getElementById('videoDropzone');
            const videoInput = document.getElementById('videoInput');
            const videoPreview = document.getElementById('videoPreview');
            const previewVideo = document.getElementById('previewVideo');

            videoDropzone.addEventListener('click', () => videoInput.click());
            
            videoDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                videoDropzone.classList.add('border-indigo-500');
            });
            
            videoDropzone.addEventListener('dragleave', () => {
                videoDropzone.classList.remove('border-indigo-500');
            });
            
            videoDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                videoDropzone.classList.remove('border-indigo-500');
                handleVideoFile(e.dataTransfer.files[0]);
            });
            
            videoInput.addEventListener('change', (e) => {
                handleVideoFile(e.target.files[0]);
            });

            function handleVideoFile(file) {
                if (file && file.type.startsWith('video/')) {
                    selectedFiles = [file];
                    const videoURL = URL.createObjectURL(file);
                    previewVideo.src = videoURL;
                    videoPreview.classList.remove('hidden');
                }
            }
        }

        function setupProfilePictureUpload() {
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const avatarInput = document.getElementById('avatarInput');
            
            changeAvatarBtn.addEventListener('click', () => avatarInput.click());
            
            avatarInput.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        try {
                            // Upload to Firebase Storage
                            const fileName = `avatars/${currentUser.uid}_${Date.now()}`;
                            const storageRef = window.firebaseServices.ref(window.firebaseStorage, fileName);
                            await window.firebaseServices.uploadBytes(storageRef, file);
                            
                            // Get download URL
                            const downloadURL = await window.firebaseServices.getDownloadURL(storageRef);
                            
                            // Update user profile in Firestore
                            await window.firebaseServices.updateDoc(
                                window.firebaseServices.doc(window.firebaseDB, 'users', currentUser.uid),
                                { photoURL: downloadURL }
                            );
                            
                            // Update auth profile
                            await updateAuthProfile({ photoURL: downloadURL });
                            
                            // Update UI
                            document.getElementById('userAvatar').src = downloadURL;
                            document.getElementById('profileAvatar').src = downloadURL;
                            
                            showNotification('Profile picture updated!', 'success');
                        } catch (error) {
                            showNotification('Failed to update profile picture', 'error');
                            console.error(error);
                        }
                    }
                }
            });
        }

        async function updateAuthProfile(updates) {
            try {
                await window.firebaseServices.updateProfile(window.firebaseAuth.currentUser, updates);
                currentUser = window.firebaseAuth.currentUser;
                return true;
            } catch (error) {
                console.error('Error updating auth profile:', error);
                return false;
            }
        }

        function setupFormSubmissions() {
            // Text post form
            document.getElementById('textPostForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = document.getElementById('textContent').value;
                const tags = document.getElementById('textTags').value;
                
                await createPost('text', {
                    content,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag)
                });
            });

            // Image post form
            document.getElementById('imagePostForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (selectedFiles.length === 0) {
                    showNotification('Please select at least one image', 'error');
                    return;
                }
                
                const caption = document.getElementById('imageCaption').value;
                const tags = document.getElementById('imageTags').value;
                
                await createPost('image', {
                    caption,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    files: selectedFiles
                });
            });

            // Video post form
            document.getElementById('videoPostForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (selectedFiles.length === 0) {
                    showNotification('Please select a video file', 'error');
                    return;
                }
                
                const description = document.getElementById('videoDescription').value;
                const tags = document.getElementById('videoTags').value;
                
                await createPost('video', {
                    description,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    files: selectedFiles
                });
            });

            // Profile form
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('settingsName').value;
                const bio = document.getElementById('settingsBio').value;
                
                try {
                    // Update Firestore
                    await window.firebaseServices.updateDoc(
                        window.firebaseServices.doc(window.firebaseDB, 'users', currentUser.uid),
                        { name, bio }
                    );
                    
                    // Update auth profile
                    await updateAuthProfile({ displayName: name });
                    
                    // Update UI
                    document.getElementById('userName').textContent = name;
                    document.getElementById('profileName').textContent = name;
                    document.getElementById('profileBio').textContent = bio;
                    
                    showNotification('Profile updated successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to update profile', 'error');
                    console.error(error);
                }
            });
        }

        // Create post function
        async function createPost(type, data) {
            try {
                const postData = {
                    type,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || 'User',
                    authorAvatar: currentUser.photoURL || '',
                    createdAt: window.firebaseServices.serverTimestamp(),
                    likes: 0,
                    comments: 0,
                    likesList: []
                };

                if (type === 'text') {
                    postData.content = data.content;
                    postData.tags = data.tags;
                } else if (type === 'image') {
                    postData.caption = data.caption;
                    postData.tags = data.tags;
                    postData.images = await uploadFiles(data.files, 'images');
                } else if (type === 'video') {
                    postData.description = data.description;
                    postData.tags = data.tags;
                    postData.videos = await uploadFiles(data.files, 'videos');
                }

                await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'posts'),
                    postData
                );

                showNotification('Post created successfully!', 'success');
                resetUploadForms();
                loadPosts();

            } catch (error) {
                console.error('Error creating post:', error);
                showNotification('Failed to create post', 'error');
            }
        }

        // Upload files to Firebase Storage
        async function uploadFiles(files, folder) {
            const uploadPromises = files.map(async (file, index) => {
                const fileName = `${Date.now()}_${index}_${file.name}`;
                const storageRef = window.firebaseServices.ref(window.firebaseStorage, `${folder}/${fileName}`);
                
                return new Promise((resolve, reject) => {
                    const uploadTask = window.firebaseServices.uploadBytesResumable(storageRef, file);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            updateUploadProgress(folder, progress);
                        },
                        (error) => reject(error),
                        async () => {
                            const downloadURL = await window.firebaseServices.getDownloadURL(uploadTask.snapshot.ref);
                            resolve(downloadURL);
                        }
                    );
                });
            });

            return Promise.all(uploadPromises);
        }

        function updateUploadProgress(type, progress) {
            const progressBar = document.getElementById(`${type === 'images' ? 'image' : 'video'}Progress`);
            const progressFill = progressBar.querySelector('.progress-fill');
            
            progressBar.classList.remove('hidden');
            progressFill.style.width = `${progress}%`;
            
            if (progress === 100) {
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        // Load posts
        async function loadPosts() {
            try {
                const postsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'posts'),
                    window.firebaseServices.orderBy('createdAt', 'desc'),
                    window.firebaseServices.limit(10)
                );

                window.firebaseServices.onSnapshot(postsQuery, (snapshot) => {
                    const postsContainer = document.getElementById('postsContainer');
                    postsContainer.innerHTML = '';
                    
                    snapshot.docs.forEach((doc) => {
                        const post = doc.data();
                        postsContainer.innerHTML += createPostHTML(post, doc.id);
                    });
                });

            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }

        function createPostHTML(post, postId) {
            const timeAgo = post.createdAt ? 'Just now' : 'Loading...';
            let mediaHTML = '';

            if (post.type === 'image' && post.images) {
                mediaHTML = post.images.map(url => 
                    `<img src="${url}" alt="Post image" class="post-image mb-3">`
                ).join('');
            } else if (post.type === 'video' && post.videos) {
                mediaHTML = post.videos.map(url => 
                    `<video controls playsinline webkit-playsinline class="post-video mb-3">
                        <source src="${url}" type="video/mp4">
                    </video>`
                ).join('');
            }

            const tagsHTML = post.tags ? post.tags.map(tag => 
                `<span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">#${tag}</span>`
            ).join(' ') : '';

            // Check if current user has liked the post
            const isLiked = post.likesList && post.likesList.includes(currentUser.uid);
            
            return `
                <div class="card fade-in" data-post-id="${postId}">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <img src="${post.authorAvatar || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face'}" alt="User" class="user-avatar mr-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${post.authorName}</h4>
                                <p class="text-sm text-gray-500">${timeAgo}</p>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            ${post.content ? `<p class="text-gray-800 mb-3">${post.content}</p>` : ''}
                            ${post.caption ? `<p class="text-gray-800 mb-3">${post.caption}</p>` : ''}
                            ${post.description ? `<p class="text-gray-800 mb-3">${post.description}</p>` : ''}
                            ${mediaHTML}
                            <div class="flex flex-wrap gap-2">
                                ${tagsHTML}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center py-3 border-t border-gray-100">
                            <button class="flex items-center ${isLiked ? 'text-red-500' : 'text-gray-600'} hover:text-red-500 transition-colors" onclick="likePost('${postId}', ${isLiked})">
                                <i class="${isLiked ? 'fas' : 'far'} fa-heart mr-2"></i>
                                <span>${post.likes || 0} Likes</span>
                            </button>
                            <button class="flex items-center text-gray-600 hover:text-indigo-500 transition-colors" onclick="showComments('${postId}')">
                                <i class="far fa-comment mr-2"></i>
                                <span>${post.comments || 0} Comments</span>
                            </button>
                            <button class="flex items-center text-gray-600 hover:text-green-500 transition-colors">
                                <i class="fas fa-share mr-2"></i>
                                <span>Share</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load user data
        function loadUserData() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || 'User';
                document.getElementById('userAvatar').src = currentUser.photoURL || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face';
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const userDoc = await window.firebaseServices.getDoc(
                    window.firebaseServices.doc(window.firebaseDB, 'users', currentUser.uid)
                );
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('profileName').textContent = userData.name || 'User';
                    document.getElementById('profileEmail').textContent = currentUser.email;
                    document.getElementById('profileBio').textContent = userData.bio || '';
                    document.getElementById('profileAvatar').src = currentUser.photoURL || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=128&h=128&fit=crop&crop=face';
                    
                    // Load user posts
                    loadUserPosts();
                    
                    // Load user stats
                    loadUserStats();
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        async function loadUserPosts() {
            try {
                const postsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'posts'),
                    window.firebaseServices.where('authorId', '==', currentUser.uid),
                    window.firebaseServices.orderBy('createdAt', 'desc')
                );

                const querySnapshot = await window.firebaseServices.getDocs(postsQuery);
                const userPostsContainer = document.getElementById('userPosts');
                userPostsContainer.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    userPostsContainer.innerHTML += createUserPostHTML(post, doc.id);
                });
            } catch (error) {
                console.error('Error loading user posts:', error);
            }
        }

        function createUserPostHTML(post, postId) {
            let mediaHTML = '';
            
            if (post.type === 'image' && post.images) {
                mediaHTML = `<img src="${post.images[0]}" alt="Post" class="w-full h-40 object-cover rounded-lg">`;
            } else if (post.type === 'video' && post.videos) {
                mediaHTML = `
                    <div class="relative w-full h-40 rounded-lg bg-black flex items-center justify-center">
                        <video class="w-full h-full object-cover rounded-lg">
                            <source src="${post.videos[0]}" type="video/mp4">
                        </video>
                        <i class="fas fa-play absolute text-white text-2xl"></i>
                    </div>
                `;
            } else if (post.type === 'text') {
                mediaHTML = `<div class="w-full h-40 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><i class="fas fa-font text-4xl"></i></div>`;
            }
            
            return `
                <div class="cursor-pointer" onclick="showPostDetail('${postId}')">
                    ${mediaHTML}
                    <p class="text-sm text-gray-600 mt-2 truncate">${post.content || post.caption || post.description || 'Post'}</p>
                </div>
            `;
        }

        async function loadUserStats() {
            try {
                // Count posts
                const postsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'posts'),
                    window.firebaseServices.where('authorId', '==', currentUser.uid)
                );
                const postsSnapshot = await window.firebaseServices.getDocs(postsQuery);
                document.getElementById('postCount').textContent = postsSnapshot.size;
                
                // TODO: Implement followers and following counts
                // For now we'll use placeholder values
                document.getElementById('followerCount').textContent = '42';
                document.getElementById('followingCount').textContent = '24';
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        async function loadSettingsData() {
            try {
                const userDoc = await window.firebaseServices.getDoc(
                    window.firebaseServices.doc(window.firebaseDB, 'users', currentUser.uid)
                );
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('settingsName').value = userData.name || '';
                    document.getElementById('settingsEmail').value = currentUser.email;
                    document.getElementById('settingsBio').value = userData.bio || '';
                    document.getElementById('privacySetting').value = userData.privacy || 'public';
                    document.getElementById('allowComments').checked = userData.allowComments !== false;
                }
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load stories
        async function loadStories() {
            try {
                // In a real app, you would fetch stories from Firestore
                // For this example, we'll use mock data
                stories = [
                    {
                        id: '1',
                        userId: 'user1',
                        userName: 'Sarah Wilson',
                        userAvatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b1e5?w=64&h=64&fit=crop&crop=face',
                        imageUrl: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=800&fit=crop',
                        createdAt: new Date()
                    },
                    {
                        id: '2',
                        userId: 'user2',
                        userName: 'John Doe',
                        userAvatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=64&h=64&fit=crop&crop=face',
                        imageUrl: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800&h=800&fit=crop',
                        createdAt: new Date()
                    },
                    {
                        id: '3',
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'You',
                        userAvatar: currentUser.photoURL || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=64&h=64&fit=crop&crop=face',
                        imageUrl: 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?w=800&h=800&fit=crop',
                        createdAt: new Date()
                    }
                ];
                
                renderStories();
            } catch (error) {
                console.error('Error loading stories:', error);
            }
        }

        function renderStories() {
            const storiesContainer = document.getElementById('storiesContainer');
            storiesContainer.innerHTML = '';
            
            // Add "Add Story" button for current user
            storiesContainer.innerHTML += `
                <div class="flex-shrink-0 text-center cursor-pointer" onclick="addStory()">
                    <div class="story-ring w-16 h-16 mx-auto mb-2">
                        <div class="story-inner w-full h-full flex items-center justify-center">
                            <i class="fas fa-plus text-gray-400"></i>
                        </div>
                    </div>
                    <p class="text-xs text-white">Add Story</p>
                </div>
            `;
            
            // Add other stories
            stories.forEach((story, index) => {
                storiesContainer.innerHTML += `
                    <div class="flex-shrink-0 text-center cursor-pointer" onclick="viewStory(${index})">
                        <div class="story-ring w-16 h-16 mx-auto mb-2">
                            <div class="story-inner w-full h-full">
                                <img src="${story.userAvatar}" alt="Story" class="w-full h-full object-cover rounded-full">
                            </div>
                        </div>
                        <p class="text-xs text-white">${story.userId === currentUser.uid ? 'You' : story.userName}</p>
                    </div>
                `;
            });
        }

        function setupStoryViewer() {
            const closeStoryBtn = document.getElementById('closeStory');
            const storyViewer = document.getElementById('storyViewer');
            
            closeStoryBtn.addEventListener('click', () => {
                storyViewer.classList.add('hidden');
                clearInterval(storyInterval);
            });
        }

        function viewStory(index) {
            currentStoryIndex = index;
            const story = stories[index];
            const storyViewer = document.getElementById('storyViewer');
            const storyImage = document.getElementById('storyImage');
            const progressFill = document.querySelector('.story-progress-fill');
            
            storyImage.src = story.imageUrl;
            storyViewer.classList.remove('hidden');
            
            // Reset and start progress bar
            progressFill.style.width = '0%';
            progressFill.style.transition = 'width 5s linear';
            progressFill.style.width = '100%';
            
            // Set timeout to go to next story or close
            clearInterval(storyInterval);
            storyInterval = setTimeout(() => {
                if (currentStoryIndex < stories.length - 1) {
                    viewStory(currentStoryIndex + 1);
                } else {
                    storyViewer.classList.add('hidden');
                }
            }, 5000);
        }

        function addStory() {
            // In a real app, this would open a file picker and upload the story
            showNotification('Story feature coming soon!', 'success');
        }

        // Setup comment modal
        function setupCommentModal() {
            const commentModal = document.getElementById('commentModal');
            const closeCommentModal = document.getElementById('closeCommentModal');
            const postCommentBtn = document.getElementById('postCommentBtn');
            
            closeCommentModal.addEventListener('click', () => {
                commentModal.classList.remove('show');
            });
            
            postCommentBtn.addEventListener('click', async () => {
                const commentInput = document.getElementById('commentInput');
                const commentText = commentInput.value.trim();
                
                if (commentText && currentPostId) {
                    try {
                        // Add comment to Firestore
                        await window.firebaseServices.addDoc(
                            window.firebaseServices.collection(window.firebaseDB, 'posts', currentPostId, 'comments'),
                            {
                                userId: currentUser.uid,
                                userName: currentUser.displayName || 'User',
                                userAvatar: currentUser.photoURL || '',
                                text: commentText,
                                createdAt: window.firebaseServices.serverTimestamp()
                            }
                        );
                        
                        // Update comment count on post
                        await window.firebaseServices.updateDoc(
                            window.firebaseServices.doc(window.firebaseDB, 'posts', currentPostId),
                            {
                                comments: window.firebaseServices.increment(1)
                            }
                        );
                        
                        commentInput.value = '';
                        showNotification('Comment posted!', 'success');
                    } catch (error) {
                        showNotification('Failed to post comment', 'error');
                        console.error(error);
                    }
                }
            });
        }

        async function showComments(postId) {
            currentPostId = postId;
            const commentModal = document.getElementById('commentModal');
            const commentList = document.getElementById('commentList');
            
            // Load comments
            try {
                const commentsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'posts', postId, 'comments'),
                    window.firebaseServices.orderBy('createdAt', 'desc')
                );
                
                window.firebaseServices.onSnapshot(commentsQuery, (snapshot) => {
                    commentList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        commentList.innerHTML = '<p class="text-gray-500 text-center py-4">No comments yet</p>';
                        return;
                    }
                    
                    snapshot.docs.forEach(doc => {
                        const comment = doc.data();
                        commentList.innerHTML += createCommentHTML(comment);
                    });
                });
                
                commentModal.classList.add('show');
            } catch (error) {
                showNotification('Failed to load comments', 'error');
                console.error(error);
            }
        }

        function createCommentHTML(comment) {
            return `
                <div class="comment-item">
                    <div class="flex items-start">
                        <img src="${comment.userAvatar || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face'}" 
                             alt="${comment.userName}" 
                             class="user-avatar w-8 h-8 mr-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-sm">${comment.userName}</h4>
                            <p class="text-gray-800 text-sm">${comment.text}</p>
                            <p class="text-gray-500 text-xs mt-1">${comment.createdAt?.toDate ? comment.createdAt.toDate().toLocaleTimeString() : 'Just now'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Like post function
        async function likePost(postId, isLiked) {
            try {
                const postRef = window.firebaseServices.doc(window.firebaseDB, 'posts', postId);
                
                if (isLiked) {
                    // Unlike the post
                    await window.firebaseServices.updateDoc(postRef, {
                        likes: window.firebaseServices.increment(-1),
                        likesList: window.firebaseServices.arrayRemove(currentUser.uid)
                    });
                } else {
                    // Like the post
                    await window.firebaseServices.updateDoc(postRef, {
                        likes: window.firebaseServices.increment(1),
                        likesList: window.firebaseServices.arrayUnion(currentUser.uid)
                    });
                }
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }

        // Setup search functionality
        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            
            searchBox.addEventListener('keyup', async (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = searchBox.value.trim();
                    
                    if (searchTerm) {
                        try {
                            // Search posts by tags or content
                            const postsQuery = window.firebaseServices.query(
                                window.firebaseServices.collection(window.firebaseDB, 'posts'),
                                window.firebaseServices.where('tags', 'array-contains', searchTerm)
                            );
                            
                            const querySnapshot = await window.firebaseServices.getDocs(postsQuery);
                            const postsContainer = document.getElementById('postsContainer');
                            postsContainer.innerHTML = '';
                            
                            if (querySnapshot.empty) {
                                postsContainer.innerHTML = '<div class="card p-6 text-center">No posts found matching your search</div>';
                                return;
                            }
                            
                            querySnapshot.forEach((doc) => {
                                const post = doc.data();
                                postsContainer.innerHTML += createPostHTML(post, doc.id);
                            });
                            
                            // Show home page
                            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                            document.getElementById('home-page').classList.add('active');
                            
                            // Update nav
                            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                            document.querySelector('.nav-link[data-page="home"]').classList.add('active');
                            
                        } catch (error) {
                            console.error('Error searching:', error);
                            showNotification('Failed to search', 'error');
                        }
                    }
                }
            });
        }

        // Utility functions
        function resetUploadForms() {
            document.getElementById('textPostForm').reset();
            document.getElementById('imagePostForm').reset();
            document.getElementById('videoPostForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('videoPreview').classList.add('hidden');
            selectedFiles = [];
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            document.getElementById('imageInput').value = '';
            // Refresh preview
            const event = new Event('change');
            document.getElementById('imageInput').dispatchEvent(event);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function setupEventListeners() {
            // Upload tabs
            const uploadTabs = document.querySelectorAll('.upload-tab');
            uploadTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    uploadTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Delete account button
            document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
                    try {
                        // In a real app, you would also delete all user data
                        await window.firebaseServices.deleteUser(currentUser);
                        showNotification('Account deleted successfully', 'success');
                    } catch (error) {
                        showNotification('Failed to delete account', 'error');
                        console.error(error);
                    }
                }
            });

            // Add upload tab styles
            const style = document.createElement('style');
            style.textContent = `
                .upload-tab {
                    padding: 0.75rem 1.5rem;
                    border-bottom: 2px solid transparent;
                    color: #6b7280;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                .upload-tab.active {
                    color: #4f46e5;
                    border-bottom-color: #4f46e5;
                    font-weight: 600;
                }
                .upload-tab:hover {
                    color: #4f46e5;
                }
            `;
            document.head.appendChild(style);
        }

        // Make functions globally available
        window.removeFile = removeFile;
        window.likePost = likePost;
        window.showComments = showComments;
        window.viewStory = viewStory;
        window.addStory = addStory;
    </script>
</body>
</html>
