<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Post</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.9.96/css/materialdesignicons.min.css">
    <style>
        .custom-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .custom-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4B5563;
            transition: .4s;
            border-radius: 22px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #FF554F;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .progress-bar-animation {
            animation: progress-animation 2s linear infinite;
            background-size: 200% 100%;
            background-image: linear-gradient(to right, #FF554F 0%, #FF8A85 50%, #FF554F 100%);
        }
        
        @keyframes progress-animation {
            0% {
                background-position: 100% 0;
            }
            100% {
                background-position: 0 0;
            }
        }
        
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div class="max-w-md mx-auto pb-16 relative min-h-screen">
        <!-- Action Bar -->
        <div class="sticky top-0 z-50 bg-gray-900 px-4 py-3 flex items-center border-b border-gray-800 shadow-md">
            <div class="text-2xl mr-4 cursor-pointer hover:text-gray-300 transition" onclick="goBack()">
                <i class="mdi mdi-arrow-left"></i>
            </div>
            <div class="text-lg font-medium flex-grow">New Post</div>
            <div id="post-button" class="text-red-500 font-medium cursor-pointer hover:text-red-400 transition px-2 py-1 rounded" onclick="uploadPost()">
                Post
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="p-4" id="main-content">
            <div class="text-gray-400 text-sm mt-2 mb-2">Say Something!</div>
            <textarea id="post-text" class="w-full bg-gray-800 rounded-lg p-4 text-gray-100 resize-none min-h-32 focus:outline-none focus:ring-2 focus:ring-red-500 transition" placeholder="What's your &quot;MANN&quot; ???"></textarea>
            
            <!-- Attachment Button -->
            <div class="flex space-x-2 mt-4">
                <label for="image-upload" class="flex items-center bg-gray-800 text-gray-400 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                    <i class="mdi mdi-image-multiple mr-2"></i>
                    <span>Add Photos</span>
                </label>
                
                <label for="video-upload" class="flex items-center bg-gray-800 text-gray-400 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                    <i class="mdi mdi-video mr-2"></i>
                    <span>Add Video</span>
                </label>
            </div>
            <input type="file" id="image-upload" accept="image/*" multiple class="hidden">
            <input type="file" id="video-upload" accept="video/*" class="hidden">
            
            <!-- Selected Images -->
            <div class="flex overflow-x-auto space-x-2 py-4 scrollbar-hide" id="selected-images"></div>
            
            <!-- Video Section -->
            <div class="mt-6 hidden" id="video-section">
                <div class="text-gray-400 text-sm mb-2">Video Details</div>
                
                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                    <div class="flex mb-2">
                        <div class="w-20 text-gray-300 text-sm">Name:</div>
                        <div class="flex-grow text-gray-300 text-sm truncate" id="video-name">No video selected</div>
                    </div>
                    <div class="flex mb-2">
                        <div class="w-20 text-gray-300 text-sm">Size:</div>
                        <div class="flex-grow text-gray-300 text-sm" id="video-size">0 MB</div>
                    </div>
                    <div class="flex">
                        <div class="w-20 text-gray-300 text-sm">Duration:</div>
                        <div class="flex-grow text-gray-300 text-sm" id="video-duration">00:00</div>
                    </div>
                </div>
                
                <button class="w-full bg-gray-800 text-gray-300 hover:bg-gray-700 transition py-3 rounded-lg flex items-center justify-center mb-4" id="change-video-btn">
                    <i class="mdi mdi-video mr-2"></i>
                    Change Video
                </button>
                
                <div class="text-gray-400 text-sm mb-2">ADD Video Thumbnail</div>
                
                <label for="thumbnail-upload" class="w-full bg-gray-800 text-gray-300 hover:bg-gray-700 transition py-3 rounded-lg flex items-center justify-center mb-4 cursor-pointer" id="thumbnail-btn">
                    <i class="mdi mdi-image mr-2"></i>
                    Pick Thumbnail
                </label>
                <input type="file" id="thumbnail-upload" accept="image/*" class="hidden">
                
                <div class="hidden mb-4" id="thumbnail-container">
                    <img src="" class="w-full h-48 object-contain rounded-lg bg-gray-800" id="thumbnail-preview">
                </div>
                
                <div class="hidden mb-4" id="short-thumbnail-container">
                    <img src="" class="w-40 h-40 mx-auto object-cover rounded-lg bg-gray-800" id="short-thumbnail-preview">
                </div>
                
                <div class="text-gray-400 text-sm mb-2" id="video-title-label">Video Title</div>
                <input type="text" id="video-title" class="w-full bg-gray-800 rounded-lg p-4 text-gray-100 mb-6 focus:outline-none focus:ring-2 focus:ring-red-500 transition" placeholder="Video Title">
                
                <div class="text-gray-400 text-sm mb-2">Advanced Options</div>
                
                <div class="bg-gray-800 rounded-lg p-4 mb-2 flex items-center justify-between">
                    <div class="text-gray-300 text-sm">Disable Comment</div>
                    <label class="custom-switch">
                        <input type="checkbox" id="disable-comment">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4 mb-2 flex items-center justify-between">
                    <div class="text-gray-300 text-sm">Disable Share</div>
                    <label class="custom-switch">
                        <input type="checkbox" id="disable-share">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-4 mb-2 flex items-center justify-between">
                    <div class="text-gray-300 text-sm">Disable Download</div>
                    <label class="custom-switch">
                        <input type="checkbox" id="disable-download">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="py-4 text-center text-xs text-gray-500">
                Your post will be visible to everyone
            </div>
        </div>
        
        <!-- Uploading Screen -->
        <div class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 hidden fade-in" id="uploading-screen">
            <img src="user.png" class="w-24 h-24 mb-6 rounded-full object-cover bg-gray-800" id="upload-avatar">
            <div class="text-xl text-red-500 mb-2 font-medium">Uploading Post...</div>
            <div class="text-gray-400 mb-4" id="task-text">TASK 0/0</div>
            <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden mb-3">
                <div class="h-full w-0 progress-bar-animation rounded-full" id="progress-fill"></div>
            </div>
            <div class="text-lg text-gray-300" id="progress-text">0% Uploaded...</div>
        </div>
        
        <!-- Error Toast -->
        <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden fade-in" id="error-toast">
            <div class="flex items-center">
                <i class="mdi mdi-alert-circle mr-2"></i>
                <span id="error-message">Error message here</span>
            </div>
        </div>
        
        <!-- Success Toast -->
        <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hidden fade-in" id="success-toast">
            <div class="flex items-center">
                <i class="mdi mdi-check-circle mr-2"></i>
                <span id="success-message">Success message here</span>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB49vRPX8YaWuTP5GS3lsBDqdAaz_hJYAw",
            authDomain: "onlineshop-849c8.firebaseapp.com",
            databaseURL: "https://onlineshop-849c8.firebaseio.com",
            projectId: "onlineshop-849c8",
            storageBucket: "onlineshop-849c8.appspot.com",
            messagingSenderId: "883512833370",
            appId: "1:883512833370:web:a1c8412b158f8744afef63"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Current user and upload data
        let currentUser = null;
        let selectedImages = [];
        let selectedVideo = null;
        let selectedThumbnail = null;
        let isShortVideo = false;
        let uploadTasks = [];
        let currentUploadIndex = 0;
        let postKey = null;
        
        // DOM elements
        const postText = document.getElementById('post-text');
        const imageUpload = document.getElementById('image-upload');
        const videoUpload = document.getElementById('video-upload');
        const thumbnailUpload = document.getElementById('thumbnail-upload');
        const selectedImagesContainer = document.getElementById('selected-images');
        const videoSection = document.getElementById('video-section');
        const videoName = document.getElementById('video-name');
        const videoSize = document.getElementById('video-size');
        const videoDuration = document.getElementById('video-duration');
        const thumbnailPreview = document.getElementById('thumbnail-preview');
        const thumbnailContainer = document.getElementById('thumbnail-container');
        const shortThumbnailPreview = document.getElementById('short-thumbnail-preview');
        const shortThumbnailContainer = document.getElementById('short-thumbnail-container');
        const videoTitle = document.getElementById('video-title');
        const videoTitleLabel = document.getElementById('video-title-label');
        const changeVideoBtn = document.getElementById('change-video-btn');
        const thumbnailBtn = document.getElementById('thumbnail-btn');
        const uploadingScreen = document.getElementById('uploading-screen');
        const taskText = document.getElementById('task-text');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const disableComment = document.getElementById('disable-comment');
        const disableShare = document.getElementById('disable-share');
        const disableDownload = document.getElementById('disable-download');
        const errorToast = document.getElementById('error-toast');
        const errorMessage = document.getElementById('error-message');
        const successToast = document.getElementById('success-toast');
        const successMessage = document.getElementById('success-message');
        const uploadAvatar = document.getElementById('upload-avatar');
        const postButton = document.getElementById('post-button');
        
        // Toast functions
        function showError(message, duration = 3000) {
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            errorToast.classList.add('shake-animation');
            
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, duration);
        }
        
        function showSuccess(message, duration = 3000) {
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, duration);
        }
        
        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                // Get user profile picture if available
                database.ref('users/' + user.uid).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.profilepic) {
                            uploadAvatar.src = userData.profilepic;
                        }
                    })
                    .catch(error => {
                        console.error("Error getting user data:", error);
                    });
            } else {
                // Redirect to login if not authenticated
                window.location.href = 'index.html';
            }
        });
        
        // Handle image upload
        imageUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                // Hide video section if showing
                videoSection.classList.add('hidden');
                selectedVideo = null;
                selectedThumbnail = null;
                
                // Clear previous selections
                selectedImages = [];
                selectedImagesContainer.innerHTML = '';
                
                // Process each file (limit to 10 images)
                const maxImages = 10; 
                const filesToProcess = files.slice(0, maxImages);
                
                if (files.length > maxImages) {
                    showError(`Maximum ${maxImages} images allowed. Only first ${maxImages} will be used.`);
                }
                
                filesToProcess.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            selectedImages.push({
                                file: file,
                                url: event.target.result
                            });
                            
                            // Create image element
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'relative inline-block fade-in';
                            
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.className = 'w-24 h-24 object-cover rounded-lg';
                            
                            const removeBtn = document.createElement('div');
                            removeBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs cursor-pointer shadow-md';
                            removeBtn.innerHTML = 'Ã—';
                            removeBtn.onclick = () => {
                                selectedImages = selectedImages.filter(item => item.url !== event.target.result);
                                imgContainer.remove();
                                
                                if (selectedImages.length === 0) {
                                    showError("All images removed. Please add at least one image or text.");
                                }
                            };
                            
                            imgContainer.appendChild(img);
                            imgContainer.appendChild(removeBtn);
                            selectedImagesContainer.appendChild(imgContainer);
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                showSuccess(`${filesToProcess.length} image(s) selected`);
            }
        });
        
        // Handle video upload
        videoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('video/')) {
                // Check file size (limit to 100MB)
                const maxSize = 100 * 1024 * 1024; // 100MB
                if (file.size > maxSize) {
                    showError("Video size exceeds 100MB limit. Please select a smaller video.");
                    return;
                }
                
                // Clear any image selections
                selectedImages = [];
                selectedImagesContainer.innerHTML = '';
                
                // Show video section
                videoSection.classList.remove('hidden');
                selectedVideo = file;
                
                // Set video details
                videoName.textContent = file.name;
                
                // Calculate file size
                let sizeText;
                if (file.size < 1024 * 1024) {
                    sizeText = (file.size / 1024).toFixed(2) + ' KB';
                } else {
                    sizeText = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                }
                videoSize.textContent = sizeText;
                
                // Create video element to get duration
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = () => {
                    window.URL.revokeObjectURL(video.src);
                    const duration = video.duration;
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    videoDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Check if it's a short video (30 seconds or less)
                    isShortVideo = duration <= 30;
                    if (isShortVideo) {
                        thumbnailBtn.innerHTML = '<i class="mdi mdi-image mr-2"></i> Pick Thumbnail For Short';
                        thumbnailContainer.classList.add('hidden');
                        videoTitle.classList.add('hidden');
                        videoTitleLabel.classList.add('hidden');
                    } else {
                        thumbnailBtn.innerHTML = '<i class="mdi mdi-image mr-2"></i> Pick Thumbnail';
                        shortThumbnailContainer.classList.add('hidden');
                        videoTitle.classList.remove('hidden');
                        videoTitleLabel.classList.remove('hidden');
                    }
                };
                video.src = URL.createObjectURL(file);
                
                showSuccess("Video selected successfully");
            }
        });
        
        // Handle thumbnail upload
        thumbnailUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedThumbnail = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (isShortVideo) {
                        shortThumbnailPreview.src = event.target.result;
                        shortThumbnailContainer.classList.remove('hidden');
                        thumbnailBtn.innerHTML = '<i class="mdi mdi-image mr-2"></i> Change Thumbnail';
                    } else {
                        thumbnailPreview.src = event.target.result;
                        thumbnailContainer.classList.remove('hidden');
                        thumbnailBtn.innerHTML = '<i class="mdi mdi-image mr-2"></i> Change Thumbnail';
                    }
                };
                reader.readAsDataURL(file);
                
                showSuccess("Thumbnail selected");
            }
        });
        
        // Change video button
        changeVideoBtn.addEventListener('click', () => {
            videoUpload.click();
        });
        
        // Upload post
        function uploadPost() {
            if (!currentUser) {
                showError('Please sign in to post');
                return;
            }
            
            const postContent = postText.value.trim();
            
            // Validate input
            if (selectedImages.length === 0 && !selectedVideo && postContent === '') {
                showError('Please add some content or media to your post');
                postText.classList.add('ring-2', 'ring-red-500', 'shake-animation');
                setTimeout(() => {
                    postText.classList.remove('ring-2', 'ring-red-500', 'shake-animation');
                }, 1000);
                return;
            }
            
            if (selectedVideo && !selectedThumbnail) {
                showError('Please select a thumbnail for your video');
                thumbnailBtn.classList.add('ring-2', 'ring-red-500', 'shake-animation');
                setTimeout(() => {
                    thumbnailBtn.classList.remove('ring-2', 'ring-red-500', 'shake-animation');
                }, 1000);
                return;
            }
            
            // Disable post button to prevent multiple submissions
            postButton.classList.add('opacity-50', 'cursor-not-allowed');
            postButton.onclick = null;
            
            // Generate a unique key for the post
            postKey = database.ref('posts').push().key;
            
            // Show uploading screen
            document.getElementById('main-content').classList.add('hidden');
            uploadingScreen.classList.remove('hidden');
            
            // Prepare upload tasks
            uploadTasks = [];
            
            if (selectedImages.length > 0) {
                // Upload images
                taskText.textContent = `TASK: 1/${selectedImages.length + 1}`;
                
                // Upload images in sequence for better progress tracking
                uploadNextImage(0);
            } else if (selectedVideo) {
                // Upload video
                taskText.textContent = 'TASK: 1/2';
                
                const videoUploadTask = storage.ref(`posts/${postKey}_video`).put(selectedVideo);
                
                videoUploadTask.on('state_changed',
                    (snapshot) => {
                        // Update progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}% Uploaded...`;
                    },
                    (error) => {
                        console.error('Video upload failed:', error);
                        showError('Video upload failed: ' + error.message);
                        resetUploadUI();
                    },
                    () => {
                        // Video upload completed
                        videoUploadTask.snapshot.ref.getDownloadURL().then((videoUrl) => {
                            // Now upload thumbnail
                            taskText.textContent = 'TASK: 2/2';
                            progressFill.style.width = '0%';
                            progressText.textContent = 'Uploading thumbnail...';
                            
                            const thumbnailUploadTask = storage.ref(`posts/${postKey}_thumbnail`).put(selectedThumbnail);
                            
                            thumbnailUploadTask.on('state_changed',
                                (snapshot) => {
                                    // Update progress
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    progressFill.style.width = `${progress}%`;
                                    progressText.textContent = `${Math.round(progress)}% Uploaded...`;
                                },
                                (error) => {
                                    console.error('Thumbnail upload failed:', error);
                                    showError('Thumbnail upload failed: ' + error.message);
                                    resetUploadUI();
                                },
                                () => {
                                    // Thumbnail upload completed
                                    thumbnailUploadTask.snapshot.ref.getDownloadURL().then((thumbnailUrl) => {
                                        // Upload post data
                                        uploadPostData({
                                            post_type: 'video',
                                            data: thumbnailUrl,
                                            video_url: videoUrl,
                                            video_title: videoTitle.value,
                                            video_duration: videoDuration.textContent,
                                            description: postContent,
                                            uid: currentUser.uid,
                                            post_timestamp: Date.now(),
                                            posttime: new Date().toLocaleString(),
                                            hide_comment: disableComment.checked ? 'true' : 'false',
                                            hide_share: disableShare.checked ? 'true' : 'false',
                                            disable_download: disableDownload.checked ? 'true' : 'false'
                                        });
                                    }).catch(error => {
                                        console.error('Error getting thumbnail URL:', error);
                                        showError('Error getting thumbnail URL: ' + error.message);
                                        resetUploadUI();
                                    });
                                }
                            );
                        }).catch(error => {
                            console.error('Error getting video URL:', error);
                            showError('Error getting video URL: ' + error.message);
                            resetUploadUI();
                        });
                    }
                );
            } else {
                // Text-only post
                uploadPostData({
                    post_type: 'normal',
                    data: '',
                    description: postContent,
                    uid: currentUser.uid,
                    post_timestamp: Date.now(),
                    posttime: new Date().toLocaleString(),
                    hide_comment: disableComment.checked ? 'true' : 'false',
                    hide_share: disableShare.checked ? 'true' : 'false'
                });
            }
        }
        
        // Function to upload images sequentially
        function uploadNextImage(index) {
            if (index >= selectedImages.length) {
                // All images uploaded, now upload post data
                const imageUrls = uploadTasks.map(task => task.url);
                uploadPostData({
                    post_type: 'normal',
                    data: JSON.stringify(imageUrls),
                    description: postText.value.trim(),
                    uid: currentUser.uid,
                    post_timestamp: Date.now(),
                    posttime: new Date().toLocaleString(),
                    hide_comment: disableComment.checked ? 'true' : 'false',
                    hide_share: disableShare.checked ? 'true' : 'false'
                });
                return;
            }
            
            const image = selectedImages[index];
            taskText.textContent = `Uploading image ${index + 1} of ${selectedImages.length}`;
            
            const uploadTask = storage.ref(`posts/${postKey}_image_${index}`).put(image.file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}% Uploaded...`;
                },
                (error) => {
                    console.error('Upload failed:', error);
                    showError('Upload failed: ' + error.message);
                    resetUploadUI();
                },
                () => {
                    // Upload completed
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        uploadTasks.push({
                            type: 'image',
                            url: downloadURL
                        });
                        
                        // Move to next image
                        uploadNextImage(index + 1);
                    }).catch(error => {
                        console.error('Error getting download URL:', error);
                        showError('Error getting download URL: ' + error.message);
                        resetUploadUI();
                    });
                }
            );
        }
        
        // Reset UI after upload error
        function resetUploadUI() {
            uploadingScreen.classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            postButton.classList.remove('opacity-50', 'cursor-not-allowed');
            postButton.onclick = uploadPost;
        }
        
        // Upload post data to database
        function uploadPostData(postData) {
            progressText.textContent = 'Finalizing your post...';
            taskText.textContent = 'Almost done!';
            progressFill.classList.add('bg-green-500');
            progressFill.style.width = '100%';
            
            // Add the key to the post data
            postData.key = postKey;
            
            // Save to database
            database.ref('posts/' + postKey).set(postData)
                .then(() => {
                    // Success - redirect to home after short delay
                    progressText.textContent = 'Post uploaded successfully!';
                    taskText.textContent = 'Redirecting to home...';
                    
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Database error:', error);
                    showError('Failed to save post: ' + error.message);
                    resetUploadUI();
                });
        }
        
        // Go back
        function goBack() {
            if (selectedImages.length > 0 || selectedVideo || postText.value.trim() !== '') {
                if (confirm('Are you sure you want to discard this post?')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        }
        
        // Handle back button on browser
        window.addEventListener('beforeunload', function(e) {
            if (selectedImages.length > 0 || selectedVideo || postText.value.trim() !== '') {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
