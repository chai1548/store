<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Connect - Enhanced Social Media App</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/compat/firebase-app.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/compat/firebase-auth.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/compat/firebase-database.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.15.0/compat/firebase-storage.min.js"></script>
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .dark {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #f8fafc;
        }
        
        .glass {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .post-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark .post-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .dark .post-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .avatar {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        .dark .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .floating-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
        }
        
        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark transition-all duration-300" id="app">
    <!-- Navigation -->
    <nav class="glass fixed top-0 left-0 right-0 z-40 border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-share-alt text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800 dark:text-white">SocialConnect</h1>
                </div>
                
                <!-- Search -->
                <div class="hidden md:flex flex-1 max-w-md mx-8">
                    <div class="relative w-full">
                        <input type="text" id="searchInput" placeholder="Search posts, users..." 
                               class="w-full pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    
                    <div class="relative" id="userMenu">
                        <button class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <div id="userAvatar" class="w-8 h-8 avatar rounded-full flex items-center justify-center text-white font-semibold">
                                <i class="fas fa-user"></i>
                            </div>
                        </button>
                        
                        <!-- Dropdown -->
                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 glass rounded-lg shadow-lg py-2 z-50">
                            <a href="#" id="profileLink" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user mr-2"></i>Profile
                            </a>
                            <a href="#" id="settingsLink" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </a>
                            <hr class="my-2 border-gray-200 dark:border-gray-600">
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="pt-16 min-h-screen">
        <!-- Auth Section -->
        <div id="authSection" class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-md w-full glass rounded-xl p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-share-alt text-white text-2xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Welcome to SocialConnect</h2>
                    <p class="text-gray-600 dark:text-gray-300 mt-2">Connect, Share, and Discover</p>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <form id="loginFormElement" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="loginEmail" required 
                                   class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                            <input type="password" id="loginPassword" required 
                                   class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
                            <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-600 dark:text-gray-300">
                        Don't have an account? 
                        <a href="#" id="showRegister" class="text-blue-500 hover:underline">Sign up</a>
                    </p>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <form id="registerFormElement" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                            <input type="text" id="registerName" required 
                                   class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="registerEmail" required 
                                   class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                            <input type="password" id="registerPassword" required 
                                   class="w-full px-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
                            <i class="fas fa-user-plus mr-2"></i>Create Account
                        </button>
                    </form>
                    <p class="text-center mt-4 text-gray-600 dark:text-gray-300">
                        Already have an account? 
                        <a href="#" id="showLogin" class="text-blue-500 hover:underline">Sign in</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- App Content -->
        <div id="appContent" class="hidden max-w-4xl mx-auto p-4">
            <!-- Create Post -->
            <div class="glass rounded-xl p-6 mb-6 shadow-lg">
                <div class="flex items-start space-x-4">
                    <div id="currentUserAvatar" class="w-12 h-12 avatar rounded-full flex items-center justify-center text-white font-semibold">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1">
                        <textarea id="postContent" placeholder="What's on your mind?" 
                                  class="w-full p-4 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  rows="3"></textarea>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer text-gray-600 dark:text-gray-300 hover:text-blue-500">
                                    <i class="fas fa-image"></i>
                                    <span>Photo</span>
                                    <input type="file" id="imageUpload" accept="image/*" multiple class="hidden">
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer text-gray-600 dark:text-gray-300 hover:text-blue-500">
                                    <i class="fas fa-video"></i>
                                    <span>Video</span>
                                    <input type="file" id="videoUpload" accept="video/*" class="hidden">
                                </label>
                            </div>
                            <button id="sharePostBtn" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                                <i class="fas fa-share mr-2"></i>Share
                            </button>
                        </div>
                        <div id="mediaPreview" class="mt-4 hidden">
                            <div class="grid grid-cols-2 gap-2" id="imagePreviewContainer"></div>
                            <div id="videoPreviewContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Skeleton -->
            <div id="loadingSkeleton" class="space-y-6">
                <div class="glass rounded-xl p-6 shadow-lg">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 skeleton rounded-full"></div>
                        <div class="flex-1">
                            <div class="skeleton h-4 w-32 mb-2 rounded"></div>
                            <div class="skeleton h-3 w-24 mb-4 rounded"></div>
                            <div class="skeleton h-4 w-full mb-2 rounded"></div>
                            <div class="skeleton h-4 w-3/4 mb-4 rounded"></div>
                            <div class="skeleton h-40 w-full rounded-lg"></div>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-xl p-6 shadow-lg">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 skeleton rounded-full"></div>
                        <div class="flex-1">
                            <div class="skeleton h-4 w-32 mb-2 rounded"></div>
                            <div class="skeleton h-3 w-24 mb-4 rounded"></div>
                            <div class="skeleton h-4 w-full mb-2 rounded"></div>
                            <div class="skeleton h-4 w-2/3 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Posts Container -->
            <div id="postsContainer" class="space-y-6">
                <!-- Posts will be loaded here -->
            </div>
            
            <!-- No Posts Message -->
            <div id="noPostsMessage" class="hidden text-center py-12">
                <div class="w-24 h-24 mx-auto mb-4 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                    <i class="fas fa-comments text-3xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-300 mb-2">No posts yet</h3>
                <p class="text-gray-500 dark:text-gray-400">Be the first to share something!</p>
            </div>
        </div>
    </main>
    
    <!-- Floating Action Button -->
    <button id="scrollToTop" class="floating-btn w-12 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <!-- Notifications -->
    <div id="notifications" class="fixed top-20 right-4 z-50 space-y-2"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-white">Processing...</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB49vRPX8YaWuTP5GS3lsBDqdAaz_hJYAw",
            authDomain: "onlineshop-849c8.firebaseapp.com",
            databaseURL: "https://onlineshop-849c8.firebaseio.com",
            projectId: "onlineshop-849c8",
            storageBucket: "onlineshop-849c8.appspot.com",
            messagingSenderId: "883512833370",
            appId: "1:883512833370:web:a1c8412b158f8744afef63"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // App State
        let currentUser = null;
        let posts = [];
        let users = {};

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loadingSkeleton = document.getElementById('loadingSkeleton');
        const postsContainer = document.getElementById('postsContainer');
        const noPostsMessage = document.getElementById('noPostsMessage');
        const userDropdown = document.getElementById('userDropdown');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notificationsContainer = document.getElementById('notifications');

        // Utility Functions
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification glass p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            notificationsContainer.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            return new Date(timestamp).toLocaleDateString();
        }

        function getUserInitials(name) {
            return name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
        }

        // Theme Management
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                authSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                loadUserProfile();
                loadPosts();
                loadUsers();
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
        });

        // Form Handling
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                showLoading();
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back!', 'success');
            } catch (error) {
                showNotification('Login failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                showLoading();
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user profile
                await database.ref(`users/${user.uid}`).set({
                    name: sanitizeInput(name),
                    email: email,
                    createdAt: Date.now(),
                    profilePic: null
                });
                
                showNotification('Account created successfully!', 'success');
            } catch (error) {
                showNotification('Registration failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                showNotification('Logout failed: ' + error.message, 'error');
            }
        });

        // User Profile
        async function loadUserProfile() {
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    const initials = getUserInitials(userData.name);
                    document.getElementById('userAvatar').textContent = initials;
                    document.getElementById('currentUserAvatar').textContent = initials;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // User Menu
        document.getElementById('userMenu').addEventListener('click', () => {
            userDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('userMenu').contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Load Users
        async function loadUsers() {
            try {
                const snapshot = await database.ref('users').once('value');
                users = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Post Creation
        document.getElementById('sharePostBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value.trim();
            const imageFiles = document.getElementById('imageUpload').files;
            const videoFile = document.getElementById('videoUpload').files[0];
            
            if (!content && !imageFiles.length && !videoFile) {
                showNotification('Please enter some content or upload media', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const postData = {
                    userId: currentUser.uid,
                    content: sanitizeInput(content),
                    timestamp: Date.now(),
                    likes: 0,
                    comments: 0
                };
                
                // Upload media if present
                if (imageFiles.length > 0) {
                    const imageUrls = [];
                    for (let file of imageFiles) {
                        const imageRef = storage.ref(`images/${Date.now()}_${file.name}`);
                        const snapshot = await imageRef.put(file);
                        const url = await snapshot.ref.getDownloadURL();
                        imageUrls.push(url);
                    }
                    postData.images = imageUrls;
                }
                
                if (videoFile) {
                    const videoRef = storage.ref(`videos/${Date.now()}_${videoFile.name}`);
                    const snapshot = await videoRef.put(videoFile);
                    const url = await snapshot.ref.getDownloadURL();
                    postData.video = url;
                }
                
                // Save post to database
                await database.ref('posts').push(postData);
                
                // Clear form
                document.getElementById('postContent').value = '';
                document.getElementById('imageUpload').value = '';
                document.getElementById('videoUpload').value = '';
                document.getElementById('mediaPreview').classList.add('hidden');
                document.getElementById('imagePreviewContainer').innerHTML = '';
                document.getElementById('videoPreviewContainer').innerHTML = '';
                
                showNotification('Post shared successfully!', 'success');
                loadPosts();
            } catch (error) {
                showNotification('Failed to share post: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Media Preview
        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const files = e.target.files;
            const container = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('mediaPreview');
            
            container.innerHTML = '';
            
            if (files.length > 0) {
                preview.classList.remove('hidden');
                
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'relative';
                        div.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg">
                            <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="this.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        container.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                preview.classList.add('hidden');
            }
        });

        document.getElementById('videoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const container = document.getElementById('videoPreviewContainer');
            const preview = document.getElementById('mediaPreview');
            
            container.innerHTML = '';
            
            if (file) {
                preview.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    container.innerHTML = `
                        <div class="relative mt-2">
                            <video controls playsinline webkit-playsinline class="w-full h-48 object-cover rounded-lg">
                                <source src="${e.target.result}" type="video/mp4">
                            </video>
                            <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="this.parentElement.remove(); document.getElementById('videoUpload').value = '';">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        });

        // Load Posts
        async function loadPosts() {
            try {
                loadingSkeleton.classList.remove('hidden');
                postsContainer.classList.add('hidden');
                noPostsMessage.classList.add('hidden');
                
                const snapshot = await database.ref('posts').orderByChild('timestamp').once('value');
                const postsData = snapshot.val();
                
                if (postsData) {
                    posts = Object.keys(postsData).map(key => ({
                        id: key,
                        ...postsData[key]
                    })).reverse(); // Newest first
                    
                    renderPosts();
                } else {
                    posts = [];
                    noPostsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                showNotification('Failed to load posts', 'error');
            } finally {
                loadingSkeleton.classList.add('hidden');
                postsContainer.classList.remove('hidden');
            }
        }

        // Render Posts
        function renderPosts() {
            postsContainer.innerHTML = '';
            
            if (posts.length === 0) {
                noPostsMessage.classList.remove('hidden');
                return;
            }
            
            posts.forEach(post => {
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            });
        }

        // Create Post Element
        function createPostElement(post) {
            const user = users[post.userId] || { name: 'Unknown User' };
            const isOwner = currentUser && currentUser.uid === post.userId;
            
            const div = document.createElement('div');
            div.className = 'post-card glass rounded-xl p-6 shadow-lg';
            
            div.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 avatar rounded-full flex items-center justify-center text-white font-semibold">
                        ${getUserInitials(user.name)}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-gray-800 dark:text-white">${sanitizeInput(user.name)}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${formatTimeAgo(post.timestamp)}</p>
                            </div>
                            ${isOwner ? `
                                <button onclick="deletePost('${post.id}')" class="text-gray-400 hover:text-red-500">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        
                        ${post.content ? `<p class="mt-3 text-gray-700 dark:text-gray-300">${sanitizeInput(post.content)}</p>` : ''}
                        
                        ${post.images ? `
                            <div class="mt-4 grid ${post.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2'} gap-2">
                                ${post.images.map(img => `
                                    <img src="${img}" class="w-full h-48 object-cover rounded-lg cursor-pointer" onclick="openImageModal('${img}')">
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${post.video ? `
                            <div class="mt-4">
                                <video controls playsinline webkit-playsinline class="w-full h-64 object-cover rounded-lg">
                                    <source src="${post.video}" type="video/mp4">
                                </video>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                            <button onclick="toggleLike('${post.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-red-500 transition-colors">
                                <i class="far fa-heart"></i>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="flex items-center space-x-2 text-gray-500 hover:text-blue-500 transition-colors">
                                <i class="far fa-comment"></i>
                                <span>${post.comments || 0}</span>
                            </button>
                            <button onclick="sharePost('${post.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-green-500 transition-colors">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Post Actions
        async function toggleLike(postId) {
            try {
                const postRef = database.ref(`posts/${postId}`);
                const snapshot = await postRef.once('value');
                const post = snapshot.val();
                
                if (post) {
                    const newLikes = (post.likes || 0) + 1;
                    await postRef.update({ likes: newLikes });
                    
                    // Update local data
                    const postIndex = posts.findIndex(p => p.id === postId);
                    if (postIndex !== -1) {
                        posts[postIndex].likes = newLikes;
                    }
                    
                    // Update UI
                    const postElement = document.querySelector(`[onclick="toggleLike('${postId}')"]`);
                    if (postElement) {
                        const icon = postElement.querySelector('i');
                        const span = postElement.querySelector('span');
                        icon.className = 'fas fa-heart text-red-500';
                        span.textContent = newLikes;
                        postElement.onclick = null; // Prevent multiple likes
                    }
                }
            } catch (error) {
                showNotification('Failed to like post', 'error');
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            
            try {
                showLoading();
                await database.ref(`posts/${postId}`).remove();
                showNotification('Post deleted successfully', 'success');
                loadPosts();
            } catch (error) {
                showNotification('Failed to delete post', 'error');
            } finally {
                hideLoading();
            }
        }

        function sharePost(postId) {
            const url = `${window.location.origin}?post=${postId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this post',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Post link copied to clipboard!', 'success');
                });
            }
        }

        function openImageModal(src) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full p-4">
                    <img src="${src}" class="max-w-full max-h-full object-contain">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Search Functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query === '') {
                renderPosts();
                return;
            }
            
            const filteredPosts = posts.filter(post => {
                const user = users[post.userId] || { name: '' };
                return post.content.toLowerCase().includes(query) || 
                       user.name.toLowerCase().includes(query);
            });
            
            postsContainer.innerHTML = '';
            
            if (filteredPosts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-300 mb-2">No results found</h3>
                        <p class="text-gray-500 dark:text-gray-400">Try searching with different keywords</p>
                    </div>
                `;
                return;
            }
            
            filteredPosts.forEach(post => {
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            });
        });

        // Scroll to Top
        const scrollToTopBtn = document.getElementById('scrollToTop');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.remove('hidden');
            } else {
                scrollToTopBtn.classList.add('hidden');
            }
        });
        
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
        });

        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Error Handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showNotification('An unexpected error occurred', 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            showNotification('An unexpected error occurred', 'error');
        });
    </script>
</body>
</html>
